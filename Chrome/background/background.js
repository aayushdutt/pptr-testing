googleAnalytics("UA-1471148-10");var background={};background.isChrome=function(){return-1!=navigator.userAgent.toLowerCase().indexOf("chrome")?(background.isSafari=!1,!0):(-1!=navigator.userAgent.toLowerCase().indexOf("safari")&&(background.isSafari=!0),!1)}(),background.tabs=[],background.isChrome&&(background.xml2json=document.createElement("script"),background.xml2json.src="/background/xml2json.min.js",document.getElementsByTagName("head")[0].appendChild(background.xml2json),background.jQuery=document.createElement("script"),background.jQuery.src="/pages/js/jquery.min.js",document.getElementsByTagName("head")[0].appendChild(background.jQuery),chrome.runtime.onMessage.addListener(function(e,a){e.showPageAction&&(-1==background.tabs.indexOf(a.tab.id)&&background.tabs.push(a.tab.id),chrome.pageAction.show(a.tab.id),chrome.pageAction.setTitle({tabId:a.tab.id,title:"Carbon Footprint"}))}),chrome.alarms.onAlarm.addListener(function(e){"CarCheckupAlarm"===e.name&&chrome.notifications.create("CarCheckupNotification",{type:"basic",iconUrl:"images/globe-256.png",title:chrome.i18n.getMessage("notificationTitle"),message:chrome.i18n.getMessage("notificationMessage")+" "+chrome.i18n.getMessage("notificationInfoText"),eventTime:e.scheduledTime,requireInteraction:!0})}),chrome.tabs.onRemoved.addListener(function(e,a){var t=background.tabs.indexOf(e);t>-1&&background.tabs.splice(t,1)}),chrome.tabs.onUpdated.addListener(function(e,a,t){chrome.pageAction.getTitle({tabId:e},function(a){if("Carbon Footprint"!=a){var t=background.tabs.indexOf(e);t>-1&&background.tabs.splice(t,1)}})}),chrome.storage.onChanged.addListener(function(e,a){if("calculationObject"in e&&"sync"==a)for(var t=0;t<background.tabs.length;++t)chrome.tabs.reload(background.tabs[t])})),background.isSafari&&(safari.application.addEventListener("message",function(e){e.message&&("getItem"===e.message.type&&e.target.page.dispatchMessage(e.name,safari.extension.settings.getItem(e.name)),"setItem"===e.message.type&&safari.extension.settings.setItem(e.name,e.message.item)),"Initialised"===e.name&&(background.tabs.push(e.target),e.target.addEventListener("close",function(e){background.tabs.splice(background.tabs.indexOf(e.target),1)},!1))},!1),safari.extension.settings.addEventListener("change",function(e){var a=background.tabs;background.tabs=[];for(var t in a)a[t].page&&a[t].page.dispatchMessage("reload")},!1),background.setNotificationAlarm=function(){var e=safari.extension.settings.getItem("calculationObject");if(e&&e.showCheckupNotification){var a=(new Date(e.lastCheckup),new Date),t=new Date(e.lastCheckup);t.addMonths(e.nextCheckupMonth),t.addYears(e.nextCheckupYear);var n=new Date(t.getTime()-2592e5),o=n.getTime()-a.getTime();if(o<=0?background.showNotification():window.setTimeout(background.showNotification,o),a.getTime>t.getTime){var i=t.getDate(),s=t.getMonth()+1,r=t.getFullYear();i<10&&(i="0"+i),s<10&&(s="0"+s);var c=s+"/"+i+"/"+r;e.lastCheckup=c,safari.extension.settings.setItem("calculationObject",e)}}},background.showNotification=function(){if("Notification"in window)if("default"===Notification.permission)Notification.requestPermission(function(){background.showNotification()});else if("granted"===Notification.permission){var e=new Notification(background.getMessage("notificationTitle"),{body:background.getMessage("notificationInfoText"),tag:"checkupNotification"});e.onclick=function(){safari.application.activeBrowserWindow.openTab().url=safari.extension.baseURI+"pages/knowMore.html"}}},background.getMessage=function(e){return background.messages[e].message},background.loadMessages=function(){var e=safari.extension.baseURI,a=/(\w*)-/.exec(navigator.language)[1];$.ajax({type:"GET",url:e+"_locales/"+a+"/messages.json",success:function(e){background.messages=JSON.parse(e)},complete:function(){background.setNotificationAlarm()},error:function(){$.ajax({type:"GET",url:e+"_locales/en/messages.json",success:function(e){background.messages=JSON.parse(e)},complete:function(){background.setNotificationAlarm()}})}})}),background.updateInt=6048e5,background.updateExchangeRates=function(){var e;$.ajax({type:"GET",url:"http://api.fixer.io/latest?base=USD",success:function(a){e=a},complete:function(){if(background.isChrome){var a={};a.exchangeRates=e,chrome.storage.sync.set(a)}else background.isSafari&&safari.extension.settings.setItem("exchangeRates",e)}})},background.updateFuelPrices=function(){var e,a=1,t=new X2JS,n={},o=function(){e="http://www.globalpetrolprices.com/api/getGasXML_weekly.php?gasoline_diesel="+a+"&rate=USD&countries=all&p=5a27edd1afc39b27ba4ba5d33a73d7fa",$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){var o=(new XMLSerializer).serializeToString(e),i=t.xml_str2json(o);i=i.data.country;for(var s in i)n[i[s]._id]||(n[i[s]._id]={}),"0"!==i[s].gas_type.__text&&(n[i[s]._id][i[s].gas_type._id]=i[s].gas_type.__text);a+=1},complete:function(){if(a<=3)o();else if(background.isChrome){var e={};e.fuelPrices=n,chrome.storage.sync.set(e)}else background.isSafari&&safari.extension.settings.setItem("fuelPrices",n)}})};o()},background.updateResources=function(){background.updateFuelPrices(),background.updateExchangeRates();var e=new Date;if(e=e.getTime(),background.isChrome){var a={};a.time=e,chrome.storage.sync.set(a)}background.isSafari&&safari.extension.settings.setItem("time",e)},background.checkLastUpdate=function(e){var a=new Date;return a=a.getTime(),Math.abs(a-e)/background.updateInt>1},background.isChrome&&(background.jQuery.onload=function(){chrome.storage.sync.get("time",function(e){e.time?background.checkLastUpdate(e.time)&&background.updateResources():background.updateResources()}),window.setTimeout(background.updateResources,background.updateInt)}),background.isSafari&&(window.onload=function(){background.loadMessages();var e=safari.extension.settings.getItem("time");null===e?background.updateResources():background.checkLastUpdate(e)&&background.updateResources(),window.setTimeout(background.updateResources,background.updateInt)});